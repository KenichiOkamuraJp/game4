<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js ダンジョンRPG</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #00ff00;
            margin: 0;
            padding: 20px;
        }
        
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #001a00;
            border: 2px solid #00ff00;
            padding: 20px;
            border-radius: 10px;
        }
        
        .title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #ffff00;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .character-creation {
            text-align: center;
        }
        
        .stat-display {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        .dungeon-view {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .map-container {
            flex: 1;
        }
        
        .dungeon-map {
            display: grid;
            grid-template-columns: repeat(5, 40px);
            gap: 1px;
            border: 2px solid #00ff00;
            padding: 10px;
            background-color: #000;
            margin: 0 auto;
        }
        
        .cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .wall { background-color: #333; }
        .floor { background-color: #002200; }
        .player { background-color: #0066ff; color: white; }
        .enemy { background-color: #ff0000; color: white; }
        .goal { background-color: #ffff00; color: black; }
        .unknown { background-color: #111; color: #444; }
        .visited { background-color: #001100; color: #666; }
        .door-closed { background-color: #8B4513; color: #DEB887; }
        .door-open { background-color: #654321; color: #8B4513; }
        .door-locked { background-color: #8B0000; color: #FFD700; }
        .treasure-chest { background-color: #DAA520; color: #8B4513; }
        .treasure-opened { background-color: #CD853F; color: #654321; }
        .stairs-up { background-color: #4169E1; color: white; }
        .stairs-down { background-color: #8A2BE2; color: white; }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .control-btn {
            background-color: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
            border-radius: 5px;
        }
        
        .control-btn:hover {
            background-color: #006600;
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-panel {
            min-width: 250px;
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 15px;
            border-radius: 5px;
        }
        
        .message-log {
            height: 200px;
            overflow-y: auto;
            background-color: #001100;
            border: 1px solid #00ff00;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .combat-screen, .game-over-screen {
            text-align: center;
            padding: 20px;
            border: 2px solid #ff0000;
            background-color: #330000;
            border-radius: 10px;
        }
        
        .input-field {
            background-color: #001100;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 8px;
            margin: 5px;
            font-family: inherit;
            border-radius: 3px;
        }
        
        .victory-screen {
            text-align: center;
            color: #ffff00;
            font-size: 18px;
            padding: 20px;
            border: 3px solid #ffff00;
            background-color: #333300;
            border-radius: 10px;
        }
        
        .town-screen {
            text-align: center;
            padding: 20px;
        }
        
        .town-menu {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .town-panel, .guild-panel {
            background-color: #001a00;
            border: 2px solid #00ff00;
            padding: 20px;
            border-radius: 10px;
            min-width: 200px;
        }
        
        .guild-panel {
            margin: 20px auto;
            max-width: 500px;
        }
        
        .level-up-screen {
            background-color: #003300;
            border: 2px solid #ffff00;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .action-section {
            margin: 10px 0;
            padding: 10px 0;
            border-top: 1px solid #00ff00;
        }
        
        .action-section:first-child {
            border-top: none;
        }
        
        .disabled-text {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .highlight-text {
            color: #ffff00;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="game-container">
            <h1 class="title">🏰 ダンジョンクエスト 🏰</h1>
            
            <!-- キャラクター作成画面 -->
            <div v-if="gameState === 'character-creation'" class="character-creation">
                <h2>🧙‍♂️ キャラクター作成</h2>
                <div>
                    <label>名前: </label>
                    <input v-model="character.name" class="input-field" placeholder="冒険者の名前">
                </div>
                <br>
                <div class="stat-display">
                    <strong>能力値</strong><br>
                    HP: {{ character.hp }}/{{ character.maxHp }}<br>
                    攻撃力: {{ character.attack }}<br>
                    防御力: {{ character.defense }}
                </div>
                <br>
                <button @click="rollStats" class="control-btn">🎲 能力値を振り直す</button>
                <button @click="startGame" :disabled="!character.name" class="control-btn">⚔️ 冒険開始</button>
            </div>
            
            <!-- 町画面 -->
            <div v-if="gameState === 'town'" class="town-screen">
                <h2>🏘️ 冒険者の町</h2>
                <p>ようこそ、{{ character.name }}さん！</p>
                
                <div class="town-menu">
                    <div class="town-panel">
                        <h3>📊 ステータス</h3>
                        <div>レベル: {{ character.level }}</div>
                        <div>EXP: {{ character.exp }} / {{ character.expToNext }}</div>
                        <div>HP: {{ character.hp }} / {{ character.maxHp }}</div>
                        <div>攻撃力: {{ character.attack }}</div>
                        <div>防御力: {{ character.defense }}</div>
                        <div>💰 所持金: {{ character.gold }}G</div>
                    </div>
                    
                    <div class="town-panel">
                        <h3>🏥 回復の泉</h3>
                        <p>疲れた冒険者を癒します</p>
                        <button @click="fullHeal" :disabled="!canFullHeal" class="control-btn">
                            💊 完全回復 ({{ HEAL_COST }}G)
                        </button>
                        <div v-if="character.hp >= character.maxHp" class="disabled-text">
                            すでに満タンです
                        </div>
                    </div>
                    
                    <div class="town-panel">
                        <h3>🎓 冒険者ギルド</h3>
                        <p>経験を積んで強くなろう</p>
                        <button @click="enterGuild" class="control-btn">
                            📚 ギルドに入る
                        </button>
                        <div v-if="canLevelUp" class="highlight-text">
                            ⭐ レベルアップ可能！
                        </div>
                    </div>
                </div>
                
                <div class="town-panel" style="margin: 20px auto; max-width: 400px;">
                    <h3>🏰 ダンジョン</h3>
                    <p>危険なダンジョンが発見されました！</p>
                    <p><strong>報酬:</strong> {{ DUNGEON_REWARDS.gold }}G + {{ DUNGEON_REWARDS.exp }}EXP</p>
                    <button @click="enterDungeon" class="control-btn">
                        ⚔️ ダンジョンに挑戦
                    </button>
                </div>
            </div>
            
            <!-- ギルド画面 -->
            <div v-if="gameState === 'guild'" class="town-screen">
                <h2>🎓 冒険者ギルド</h2>
                <p>ここでは蓄積した経験値を使ってレベルアップできます</p>
                
                <div class="guild-panel">
                    <h3>📊 現在のステータス</h3>
                    <div>{{ character.name }} (レベル {{ character.level }})</div>
                    <div>EXP: {{ character.exp }} / {{ character.expToNext }}</div>
                    <div>HP: {{ character.maxHp }}</div>
                    <div>攻撃力: {{ character.attack }}</div>
                    <div>防御力: {{ character.defense }}</div>
                    
                    <div style="margin: 20px 0;">
                        <button v-if="canLevelUp" @click="levelUp" class="control-btn">
                            ⬆️ レベルアップ！
                        </button>
                        <div v-else class="disabled-text">
                            レベルアップには あと {{ expNeeded }}EXP 必要です
                        </div>
                    </div>
                    
                    <button @click="leaveGuild" class="control-btn">
                        🏘️ 町に戻る
                    </button>
                </div>
                
                <div v-if="levelUpMessage" class="level-up-screen">
                    <h3>🎉 レベルアップ！</h3>
                    <p style="white-space: pre-line;">{{ levelUpMessage }}</p>
                    <button @click="levelUpMessage = ''" class="control-btn">OK</button>
                </div>
            </div>
            
            <!-- ゲーム画面 -->
            <div v-if="gameState === 'playing'" class="dungeon-view">
                <div class="map-container">
                    <div class="dungeon-map">
                        <div v-for="(cell, index) in mapDisplay" :key="index" 
                             :class="['cell', getCellClass(cell)]">
                            {{ getCellSymbol(cell) }}
                        </div>
                    </div>
                    <div class="controls">
                        <div>
                            <button @click="move('up')" class="control-btn">⬆️ 北</button>
                        </div>
                        <div>
                            <button @click="move('left')" class="control-btn">⬅️ 西</button>
                            <button @click="move('down')" class="control-btn">⬇️ 南</button>
                            <button @click="move('right')" class="control-btn">➡️ 東</button>
                        </div>
                    </div>
                </div>
                
                <div class="status-panel">
                    <h3>{{ character.name }} の状態</h3>
                    <div><strong>🏰 {{ currentFloor }}階</strong></div>
                    <div>HP: {{ character.hp }}/{{ character.maxHp }}</div>
                    <div>攻撃力: {{ character.attack }}</div>
                    <div>位置: ({{ playerX }}, {{ playerY }})</div>
                    <div>🗝️ 鍵: {{ keys }}個</div>
                    
                    <div class="message-log">
                        <div v-for="(message, index) in messages" :key="index">
                            {{ message }}
                        </div>
                    </div>
                    
                    <button @click="usePotion" :disabled="!canUsePotion" class="control-btn">
                        🧪 回復薬 ({{ potions }}個)
                    </button>
                    
                    <!-- 階段ボタン -->
                    <div v-if="adjacentStairs" class="action-section">
                        <div style="text-align: center;">
                            <button @click="useStairs" class="control-btn">
                                {{ getStairsButtonText() }}
                            </button>
                        </div>
                    </div>
                    
                    <!-- 扉ボタン -->
                    <div v-if="adjacentDoor" class="action-section">
                        <div style="text-align: center;">
                            <button v-if="!adjacentDoor.isOpen && !adjacentDoor.isLocked" @click="openDoor" class="control-btn">
                                🚪 扉を開ける
                            </button>
                            <button v-if="!adjacentDoor.isOpen && adjacentDoor.isLocked && keys > 0" @click="unlockDoor" class="control-btn">
                                🗝️ 鍵で扉を開ける
                            </button>
                            <button v-if="!adjacentDoor.isOpen && adjacentDoor.isLocked && keys === 0" disabled class="control-btn">
                                🗝️ 鍵が必要です
                            </button>
                        </div>
                    </div>
                    
                    <!-- 宝箱ボタン -->
                    <div v-if="adjacentChest" class="action-section">
                        <div style="text-align: center;">
                            <button v-if="!adjacentChest.isOpened" @click="openChest" class="control-btn">
                                📦 宝箱を開ける
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 戦闘画面 -->
            <div v-if="gameState === 'combat'" class="combat-screen">
                <h2>⚔️ 戦闘！</h2>
                <div>
                    <strong>{{ currentEnemy.name }}</strong><br>
                    HP: {{ currentEnemy.hp }}/{{ currentEnemy.maxHp }}
                </div>
                <br>
                <div>
                    <strong>{{ character.name }}</strong><br>
                    HP: {{ character.hp }}/{{ character.maxHp }}
                </div>
                <br>
                <button @click="attack" class="control-btn">⚔️ 攻撃</button>
                <button @click="flee" class="control-btn">🏃 逃げる</button>
            </div>
            
            <!-- 勝利画面 -->
            <div v-if="gameState === 'victory'" class="victory-screen">
                <h2>🏆 ダンジョン攻略成功！ 🏆</h2>
                <p>{{ character.name }}は見事にダンジョンを攻略しました！</p>
                <div style="margin: 20px 0;">
                    <p><strong>📦 獲得報酬:</strong></p>
                    <p>💰 {{ lastReward.gold }}G を獲得！</p>
                    <p>⭐ {{ lastReward.exp }}EXP を獲得！</p>
                </div>
                <button @click="returnToTown" class="control-btn">🏘️ 町に戻る</button>
            </div>
            
            <!-- ゲームオーバー画面 -->
            <div v-if="gameState === 'game-over'" class="game-over-screen">
                <h2>💀 ゲームオーバー 💀</h2>
                <p>{{ character.name }}は力尽きてしまいました...</p>
                <button @click="resetGame" class="control-btn">🔄 もう一度プレイ</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // ゲーム定数
                    HEAL_COST: 50,
                    DUNGEON_REWARDS: { gold: 500, exp: 200 },
                    POTION_HEAL: { min: 20, max: 30 },
                    VIEW_RANGE: 2,
                    MAP_SIZE: 8,
                    INITIAL_POTIONS: 3,
                    MAX_MESSAGES: 10,
                    FLEE_SUCCESS_RATE: 0.7,
                    ITEM_DROP_RATE: 0.4,
                    
                    // ゲーム状態
                    gameState: 'character-creation',
                    character: {
                        name: '',
                        level: 1,
                        exp: 0,
                        expToNext: 100,
                        hp: 50,
                        maxHp: 50,
                        attack: 10,
                        defense: 5,
                        gold: 0
                    },
                    
                    // ダンジョン状態
                    currentFloor: 1,
                    playerX: 1,
                    playerY: 6,
                    potions: 3,
                    keys: 0,
                    messages: [],
                    currentEnemy: null,
                    doorStates: {},
                    chestStates: {},
                    visitedCells: {},
                    levelUpMessage: '',
                    lastReward: { gold: 0, exp: 0 },
                    
                    // 各階層のプレイヤー位置
                    playerPositions: {
                        1: { x: 1, y: 6 },
                        2: { x: 1, y: 1 },
                        3: { x: 1, y: 1 }
                    },
                    
                    // ダンジョンマップ (0:壁, 1:床, 2:敵, 3:ゴール, 4:扉, 5:鍵付き扉, 6:宝箱, 7:上り階段, 8:下り階段)
                    dungeonMaps: {
                        1: [
                            [0,0,0,0,0,0,0,0],
                            [0,1,1,4,1,1,1,0],
                            [0,1,0,6,2,0,1,0],
                            [0,4,0,1,1,0,1,0],
                            [0,1,1,1,0,1,1,0],
                            [0,0,0,1,2,1,0,0],
                            [0,7,1,1,8,1,1,0],
                            [0,0,0,0,0,0,0,0]
                        ],
                        2: [
                            [0,0,0,0,0,0,0,0],
                            [0,7,1,1,1,1,1,0],
                            [0,1,0,6,2,0,1,0],
                            [0,1,0,1,5,0,4,0],
                            [0,1,1,1,0,1,1,0],
                            [0,0,6,1,2,1,0,0],
                            [0,1,1,1,8,1,1,0],
                            [0,0,0,0,0,0,0,0]
                        ],
                        3: [
                            [0,0,0,0,0,0,0,0],
                            [0,7,1,1,1,1,1,0],
                            [0,1,0,6,2,0,1,0],
                            [0,5,0,1,1,0,5,0],
                            [0,1,1,1,0,1,1,0],
                            [0,0,0,5,2,5,0,0],
                            [0,6,1,1,1,1,1,0],
                            [0,0,0,0,3,0,0,0]
                        ]
                    }
                }
            },
            
            computed: {
                canLevelUp() {
                    return Number(this.character.exp) >= Number(this.character.expToNext);
                },
                
                expNeeded() {
                    return Number(this.character.expToNext) - Number(this.character.exp);
                },
                
                canFullHeal() {
                    return this.character.hp < this.character.maxHp && this.character.gold >= this.HEAL_COST;
                },
                
                canUsePotion() {
                    return this.potions > 0 && this.character.hp < this.character.maxHp;
                },
                
                mapDisplay() {
                    const display = [];
                    
                    for (let dy = -this.VIEW_RANGE; dy <= this.VIEW_RANGE; dy++) {
                        for (let dx = -this.VIEW_RANGE; dx <= this.VIEW_RANGE; dx++) {
                            const x = this.playerX + dx;
                            const y = this.playerY + dy;
                            
                            if (dx === 0 && dy === 0) {
                                display.push('player');
                                continue;
                            }
                            
                            if (x < 0 || x >= this.MAP_SIZE || y < 0 || y >= this.MAP_SIZE) {
                                display.push('unknown');
                                continue;
                            }
                            
                            display.push(this.getCellType(x, y));
                        }
                    }
                    return display;
                },
                
                adjacentStairs() {
                    return this.findAdjacentCell([7, 8], (cell, x, y) => {
                        const isUp = cell === 7;
                        const isExit = this.currentFloor === 1 && isUp;
                        const canUse = isExit || (isUp ? this.currentFloor > 1 : this.currentFloor < 3);
                        
                        return { isUp, canUse, isExit };
                    });
                },
                
                adjacentDoor() {
                    return this.findAdjacentCell([4, 5], (cell, x, y) => {
                        const doorKey = `${this.currentFloor}-${x}-${y}`;
                        return {
                            x, y,
                            isOpen: this.doorStates[doorKey] || false,
                            isLocked: cell === 5,
                            key: doorKey
                        };
                    });
                },
                
                adjacentChest() {
                    return this.findAdjacentCell([6], (cell, x, y) => {
                        const chestKey = `${this.currentFloor}-${x}-${y}`;
                        return {
                            x, y,
                            isOpened: this.chestStates[chestKey] || false,
                            key: chestKey
                        };
                    });
                }
            },
            
            mounted() {
                this.rollStats();
            },
            
            methods: {
                // 初期化・ゲーム開始
                rollStats() {
                    if (this.character.level === 1 && this.character.exp === 0) {
                        const baseHp = 40 + Math.floor(Math.random() * 21);
                        const baseAttack = 8 + Math.floor(Math.random() * 5);
                        const baseDefense = 3 + Math.floor(Math.random() * 5);
                        
                        this.character.hp = baseHp;
                        this.character.maxHp = baseHp;
                        this.character.attack = baseAttack;
                        this.character.defense = baseDefense;
                    }
                },
                
                startGame() {
                    if (!this.character.name.trim()) return;
                    this.gameState = 'town';
                    this.addMessage(`${this.character.name}さん、冒険者の町へようこそ！`);
                },
                
                // 町・ギルド関連
                enterGuild() {
                    this.gameState = 'guild';
                },
                
                leaveGuild() {
                    this.gameState = 'town';
                },
                
                enterDungeon() {
                    this.gameState = 'playing';
                    this.initializeDungeon();
                    this.addMessage(`${this.character.name}がダンジョンに入りました！`);
                    this.addMessage('3階建てのダンジョンです。最下階にある宝物を目指しましょう！');
                    this.addMessage('1階の上り階段からいつでも町に戻れます。');
                },
                
                initializeDungeon() {
                    this.currentFloor = 1;
                    this.playerX = this.playerPositions[1].x;
                    this.playerY = this.playerPositions[1].y;
                    this.messages = [];
                },
                
                fullHeal() {
                    if (this.canFullHeal) {
                        this.character.gold = Number(this.character.gold) - this.HEAL_COST;
                        this.character.hp = this.character.maxHp;
                        this.addMessage('完全回復しました！');
                    }
                },
                
                levelUp() {
                    if (!this.canLevelUp) return;
                    
                    let totalLevelUps = 0;
                    let totalHpIncrease = 0;
                    let totalAttackIncrease = 0;
                    let totalDefenseIncrease = 0;
                    
                    while (Number(this.character.exp) >= Number(this.character.expToNext)) {
                        const increases = this.performSingleLevelUp();
                        totalLevelUps++;
                        totalHpIncrease += increases.hp;
                        totalAttackIncrease += increases.attack;
                        totalDefenseIncrease += increases.defense;
                    }
                    
                    this.setLevelUpMessage(totalLevelUps, totalHpIncrease, totalAttackIncrease, totalDefenseIncrease);
                },
                
                performSingleLevelUp() {
                    this.character.exp = Number(this.character.exp) - Number(this.character.expToNext);
                    this.character.level = Number(this.character.level) + 1;
                    
                    const hpIncrease = 8 + Math.floor(Math.random() * 5);
                    const attackIncrease = 2 + Math.floor(Math.random() * 3);
                    const defenseIncrease = 1 + Math.floor(Math.random() * 3);
                    
                    this.character.maxHp = Number(this.character.maxHp) + hpIncrease;
                    this.character.hp = Number(this.character.hp) + hpIncrease;
                    this.character.attack = Number(this.character.attack) + attackIncrease;
                    this.character.defense = Number(this.character.defense) + defenseIncrease;
                    
                    this.character.expToNext = Math.floor(100 * Math.pow(1.2, this.character.level - 1));
                    
                    return { hp: hpIncrease, attack: attackIncrease, defense: defenseIncrease };
                },
                
                setLevelUpMessage(levels, hp, attack, defense) {
                    if (levels === 1) {
                        this.levelUpMessage = `レベル${this.character.level}になりました！\nHP+${hp}, 攻撃力+${attack}, 防御力+${defense}`;
                    } else {
                        this.levelUpMessage = `${levels}レベルアップ！レベル${this.character.level}になりました！\nHP+${hp}, 攻撃力+${attack}, 防御力+${defense}`;
                    }
                },
                
                // 移動・探索
                move(direction) {
                    const { newX, newY } = this.getNewPosition(direction);
                    
                    if (!this.isValidPosition(newX, newY)) {
                        this.addMessage('そちらは壁です...');
                        return;
                    }
                    
                    const cell = this.dungeonMaps[this.currentFloor][newY][newX];
                    
                    if (!this.canMoveToCell(cell, newX, newY)) return;
                    
                    this.movePlayer(newX, newY);
                    this.handleCellEvent(cell);
                },
                
                getNewPosition(direction) {
                    const directions = {
                        'up': { x: 0, y: -1 },
                        'down': { x: 0, y: 1 },
                        'left': { x: -1, y: 0 },
                        'right': { x: 1, y: 0 }
                    };
                    
                    return {
                        newX: this.playerX + directions[direction].x,
                        newY: this.playerY + directions[direction].y
                    };
                },
                
                isValidPosition(x, y) {
                    return x >= 0 && x < this.MAP_SIZE && y >= 0 && y < this.MAP_SIZE && 
                           this.dungeonMaps[this.currentFloor][y][x] !== 0;
                },
                
                canMoveToCell(cell, x, y) {
                    if (cell === 4 || cell === 5) {
                        const doorKey = `${this.currentFloor}-${x}-${y}`;
                        if (!this.doorStates[doorKey]) {
                            this.addMessage('扉が閉まっています。');
                            return false;
                        }
                    }
                    
                    if (cell === 6) {
                        this.addMessage('宝箱があるため進めません。');
                        return false;
                    }
                    
                    if (cell === 7 || cell === 8) {
                        this.addMessage('階段があります。階段ボタンを使ってください。');
                        return false;
                    }
                    
                    return true;
                },
                
                movePlayer(x, y) {
                    this.playerX = x;
                    this.playerY = y;
                    this.playerPositions[this.currentFloor].x = x;
                    this.playerPositions[this.currentFloor].y = y;
                },
                
                handleCellEvent(cell) {
                    if (cell === 2) {
                        this.startCombat();
                    } else if (cell === 3) {
                        this.lastReward = { ...this.DUNGEON_REWARDS };
                        this.gameState = 'victory';
                    } else {
                        this.addMessage(`(${this.playerX}, ${this.playerY})に移動しました`);
                    }
                },
                
                // 階段・扉・宝箱
                useStairs() {
                    if (!this.adjacentStairs || !this.adjacentStairs.canUse) return;
                    
                    if (this.adjacentStairs.isExit) {
                        this.gameState = 'town';
                        this.addMessage('ダンジョンから町に戻りました。');
                        return;
                    }
                    
                    this.currentFloor += this.adjacentStairs.isUp ? -1 : 1;
                    this.playerX = this.playerPositions[this.currentFloor].x;
                    this.playerY = this.playerPositions[this.currentFloor].y;
                    this.addMessage(`${this.currentFloor}階に移動しました。`);
                },
                
                getStairsButtonText() {
                    if (!this.adjacentStairs) return '';
                    if (this.adjacentStairs.isExit) return '🏘️ 町に戻る';
                    return this.adjacentStairs.isUp ? '⬆️ 上の階に行く' : '⬇️ 下の階に行く';
                },
                
                openDoor() {
                    if (this.adjacentDoor && !this.adjacentDoor.isOpen && !this.adjacentDoor.isLocked) {
                        this.doorStates[this.adjacentDoor.key] = true;
                        this.addMessage('扉を開けました。');
                    }
                },
                
                unlockDoor() {
                    if (this.adjacentDoor && !this.adjacentDoor.isOpen && this.adjacentDoor.isLocked && this.keys > 0) {
                        this.keys--;
                        this.doorStates[this.adjacentDoor.key] = true;
                        this.addMessage(`鍵を使って扉を開けました！残り${this.keys}個`);
                    }
                },
                
                openChest() {
                    if (!this.adjacentChest || this.adjacentChest.isOpened) return;
                    
                    this.chestStates[this.adjacentChest.key] = true;
                    const treasure = this.generateTreasure();
                    
                    this.addMessage('宝箱を開けました！');
                    this.addMessage(treasure.message);
                    
                    if (treasure.type === 'key') this.keys++;
                    if (treasure.type === 'potion') this.potions++;
                },
                
                generateTreasure() {
                    const treasures = [
                        { type: 'key', message: '✨ 鍵を見つけました！' },
                        { type: 'potion', message: '✨ 回復薬を見つけました！' },
                        { type: 'nothing', message: '宝箱は空でした...' }
                    ];
                    return treasures[Math.floor(Math.random() * treasures.length)];
                },
                
                // 戦闘システム
                startCombat() {
                    const enemies = [
                        { name: 'スライム', hp: 20, maxHp: 20, attack: 6, expReward: { min: 5, max: 10 }, goldReward: { min: 3, max: 8 } },
                        { name: 'ゴブリン', hp: 30, maxHp: 30, attack: 8, expReward: { min: 10, max: 15 }, goldReward: { min: 8, max: 15 } },
                        { name: 'オーク', hp: 40, maxHp: 40, attack: 10, expReward: { min: 15, max: 25 }, goldReward: { min: 15, max: 25 } }
                    ];
                    
                    this.currentEnemy = { ...enemies[Math.floor(Math.random() * enemies.length)] };
                    this.gameState = 'combat';
                    this.addMessage(`${this.currentEnemy.name}と遭遇！`);
                },
                
                attack() {
                    const playerDamage = Math.max(1, this.character.attack - Math.floor(Math.random() * 3));
                    this.currentEnemy.hp = Math.max(0, this.currentEnemy.hp - playerDamage);
                    this.addMessage(`${this.currentEnemy.name}に${playerDamage}のダメージ！`);
                    
                    if (this.currentEnemy.hp <= 0) {
                        this.handleEnemyDefeated();
                        return;
                    }
                    
                    this.handleEnemyAttack();
                },
                
                handleEnemyDefeated() {
                    this.addMessage(`${this.currentEnemy.name}を倒しました！`);
                    
                    // EXPと金の獲得
                    const expGained = this.getRandomReward(this.currentEnemy.expReward);
                    const goldGained = this.getRandomReward(this.currentEnemy.goldReward);
                    
                    this.character.exp = Number(this.character.exp) + expGained;
                    this.character.gold = Number(this.character.gold) + goldGained;
                    
                    this.addMessage(`${expGained}EXP、${goldGained}G を獲得！`);
                    
                    // アイテムドロップ
                    if (Math.random() < this.ITEM_DROP_RATE) {
                        this.potions++;
                        this.addMessage('回復薬を見つけました！');
                    }
                    
                    this.dungeonMaps[this.currentFloor][this.playerY][this.playerX] = 1;
                    this.gameState = 'playing';
                },
                
                handleEnemyAttack() {
                    const enemyDamage = Math.max(1, this.currentEnemy.attack - this.character.defense);
                    this.character.hp = Math.max(0, this.character.hp - enemyDamage);
                    this.addMessage(`${enemyDamage}のダメージを受けました！`);
                    
                    if (this.character.hp <= 0) {
                        this.gameState = 'game-over';
                    }
                },
                
                flee() {
                    if (Math.random() < this.FLEE_SUCCESS_RATE) {
                        this.addMessage('逃げ出しました！');
                        this.gameState = 'playing';
                        if (this.playerX > 0) this.playerX--;
                    } else {
                        this.addMessage('逃げられませんでした！');
                        this.handleEnemyAttack();
                    }
                },
                
                // アイテム使用
                usePotion() {
                    if (!this.canUsePotion) return;
                    
                    this.potions--;
                    const healAmount = this.POTION_HEAL.min + Math.floor(Math.random() * (this.POTION_HEAL.max - this.POTION_HEAL.min + 1));
                    this.character.hp = Math.min(this.character.maxHp, this.character.hp + healAmount);
                    this.addMessage(`${healAmount}HP回復しました！`);
                },
                
                // ゲーム終了・リセット
                returnToTown() {
                    this.character.gold = Number(this.character.gold) + Number(this.lastReward.gold);
                    this.character.exp = Number(this.character.exp) + Number(this.lastReward.exp);
                    this.character.hp = this.character.maxHp;
                    
                    this.resetDungeon();
                    this.gameState = 'town';
                    this.addMessage(`町に戻りました。報酬: ${this.lastReward.gold}G, ${this.lastReward.exp}EXP`);
                },
                
                resetGame() {
                    this.gameState = 'character-creation';
                    this.character = {
                        name: '',
                        level: 1,
                        exp: 0,
                        expToNext: 100,
                        hp: 50,
                        maxHp: 50,
                        attack: 10,
                        defense: 5,
                        gold: 0
                    };
                    this.levelUpMessage = '';
                    this.lastReward = { gold: 0, exp: 0 };
                    this.resetDungeon();
                },
                
                resetDungeon() {
                    this.currentFloor = 1;
                    this.playerX = 1;
                    this.playerY = 6;
                    this.potions = this.INITIAL_POTIONS;
                    this.keys = 0;
                    this.messages = [];
                    this.currentEnemy = null;
                    this.doorStates = {};
                    this.chestStates = {};
                    this.visitedCells = {};
                    
                    this.playerPositions = {
                        1: { x: 1, y: 6 },
                        2: { x: 1, y: 1 },
                        3: { x: 1, y: 1 }
                    };
                    
                    this.resetDungeonMaps();
                },
                
                resetDungeonMaps() {
                    this.dungeonMaps = {
                        1: [
                            [0,0,0,0,0,0,0,0],
                            [0,1,1,4,1,1,1,0],
                            [0,1,0,6,2,0,1,0],
                            [0,4,0,1,1,0,1,0],
                            [0,1,1,1,0,1,1,0],
                            [0,0,0,1,2,1,0,0],
                            [0,7,1,1,8,1,1,0],
                            [0,0,0,0,0,0,0,0]
                        ],
                        2: [
                            [0,0,0,0,0,0,0,0],
                            [0,7,1,1,1,1,1,0],
                            [0,1,0,6,2,0,1,0],
                            [0,1,0,1,5,0,4,0],
                            [0,1,1,1,0,1,1,0],
                            [0,0,6,1,2,1,0,0],
                            [0,1,1,1,8,1,1,0],
                            [0,0,0,0,0,0,0,0]
                        ],
                        3: [
                            [0,0,0,0,0,0,0,0],
                            [0,7,1,1,1,1,1,0],
                            [0,1,0,6,2,0,1,0],
                            [0,5,0,1,1,0,5,0],
                            [0,1,1,1,0,1,1,0],
                            [0,0,0,5,2,5,0,0],
                            [0,6,1,1,1,1,1,0],
                            [0,0,0,0,3,0,0,0]
                        ]
                    };
                },
                
                // ユーティリティ
                getRandomReward(rewardRange) {
                    return rewardRange.min + Math.floor(Math.random() * (rewardRange.max - rewardRange.min + 1));
                },
                
                getCellType(x, y) {
                    const cell = this.dungeonMaps[this.currentFloor][y][x];
                    
                    if (cell === 0) return 'wall';
                    if (cell === 1 || cell === 2) return 'floor';
                    if (cell === 3) return 'goal';
                    if (cell === 4) {
                        const doorKey = `${this.currentFloor}-${x}-${y}`;
                        return this.doorStates[doorKey] ? 'door-open' : 'door-closed';
                    }
                    if (cell === 5) {
                        const doorKey = `${this.currentFloor}-${x}-${y}`;
                        return this.doorStates[doorKey] ? 'door-open' : 'door-locked';
                    }
                    if (cell === 6) {
                        const chestKey = `${this.currentFloor}-${x}-${y}`;
                        return this.chestStates[chestKey] ? 'treasure-opened' : 'treasure-chest';
                    }
                    if (cell === 7) return 'stairs-up';
                    if (cell === 8) return 'stairs-down';
                    
                    return 'floor';
                },
                
                findAdjacentCell(cellTypes, dataFactory) {
                    const directions = [
                        { dx: 0, dy: -1 }, { dx: 0, dy: 1 }, { dx: -1, dy: 0 }, { dx: 1, dy: 0 }
                    ];
                    
                    for (let dir of directions) {
                        const x = this.playerX + dir.dx;
                        const y = this.playerY + dir.dy;
                        
                        if (x >= 0 && x < this.MAP_SIZE && y >= 0 && y < this.MAP_SIZE) {
                            const cell = this.dungeonMaps[this.currentFloor][y][x];
                            if (cellTypes.includes(cell)) {
                                return dataFactory(cell, x, y);
                            }
                        }
                    }
                    return null;
                },
                
                getCellClass(cell) {
                    return cell;
                },
                
                getCellSymbol(cell) {
                    const symbols = {
                        'wall': '█',
                        'floor': '·',
                        'player': '@',
                        'enemy': 'M',
                        'goal': '★',
                        'unknown': '?',
                        'visited': '·',
                        'door-closed': '┃',
                        'door-open': '╱',
                        'door-locked': '🔒',
                        'treasure-chest': '📦',
                        'treasure-opened': '📭',
                        'stairs-up': '⬆️',
                        'stairs-down': '⬇️'
                    };
                    return symbols[cell] || ' ';
                },
                
                addMessage(text) {
                    this.messages.push(text);
                    if (this.messages.length > this.MAX_MESSAGES) {
                        this.messages.shift();
                    }
                    
                    this.$nextTick(() => {
                        const log = document.querySelector('.message-log');
                        if (log) log.scrollTop = log.scrollHeight;
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>